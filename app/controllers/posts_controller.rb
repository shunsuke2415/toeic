class PostsController < ApplicationController
    # 診断結果コードと対応する book_number の配列を定義
    # key: 診断結果コード (String)
    # value: 推奨される book_number の配列 (Array of Integers)
    DIAGNOSIS_MAP = {
    "1111" => [1, 5, 3, 4], # 銀のフレーズ(1), 文法でる400問(5), 初めて受ける(3), 総合模試600(4)
    "1121" => [1, 5, 3, 4], # (例: 別の組み合わせ)
    "1112" => [1, 6, 3, 4, 7], 
    "1122" => [1, 6, 3, 4, 7],
    "2111" => [2, 6, 3, 4], 
    "2121" => [2, 6, 3, 4],
    "2112" => [2, 6, 3, 7], 
    "2122" => [2, 6, 3, 7], 
    "3111" => [2, 6, 7],
    "3112" => [2, 6, 7], 
    "4111" => [2, 6, 7],
    "4112" => [2, 6, 7], 
    "3121" => [2, 6, 8, 7],
    "3122" => [2, 6, 8, 7], 
    "4121" => [2, 6, 8, 7],
    "4122" => [2, 6, 8, 7], 
    "1211" => [2, 6, 7],
    "2211" => [2, 6, 7], 
    "1212" => [2, 6, 7, 9, 10],
    "2212" => [2, 6, 7, 9, 10], 
    "1221" => [2, 3, 6, 7],
    "2221" => [2, 3, 6, 7], 
    "1222" => [2, 3, 6, 7, 9, 10],
    "2222" => [2, 3, 6, 7, 9, 10], 
    "3211" => [2, 6, 11, 12],
    "4211" => [2, 6, 11, 12],
    "3212" => [2, 6, 7, 11, 12],
    "4212" => [2, 6, 7, 11, 12], 
    "3221" => [2, 6, 8, 11, 12],
    "4221" => [2, 6, 8, 11, 12], 
    "3222" => [2, 6, 7, 8, 11, 12],
    "4222" => [2, 6, 7, 8, 11, 12], 
    "1311" => [2, 6, 8, 11, 12],
    "2311" => [2, 6, 8, 11, 12], 
    "1312" => [2, 6, 7, 8, 9, 10, 11, 12],
    "2312" => [2, 6, 7, 8, 9, 10, 11, 12], 
    "1321" => [2, 3, 6, 11, 12],
    "2321" => [2, 3, 6, 11, 12], 
    "1322" => [2, 3, 6, 7, 9, 10, 11, 12],
    "2322" => [2, 3, 6, 7, 9, 10, 11, 12], 
    "3311" => [2, 6, 11, 12],
    "4311" => [2, 6, 11, 12], 
    "3312" => [2, 6, 7, 11, 12],
    "4312" => [2, 6, 7, 11, 12], 
    "3321" => [2, 6, 8, 11, 12],
    "4321" => [2, 6, 8, 11, 12], 
    "3322" => [2, 6, 7, 8, 11, 12],
    "4322" => [2, 6, 7, 8, 11, 12], 
    "1411" => [2, 6, 8, 11, 12],
    "1421" => [2, 6, 8, 11, 12], 
    "2411" => [2, 6, 8, 11, 12],
    "2421" => [2, 6, 8, 11, 12], 
    "1412" => [2, 6, 7, 8, 9, 10, 11, 12],
    "1422" => [2, 6, 7, 8, 9, 10, 11, 12], 
    "2412" => [2, 6, 7, 8, 9, 10, 11, 12],
    "2422" => [2, 6, 7, 8, 9, 10, 11, 12], 
    "3411" => [2, 6, 13, 14],
    "3412" => [2, 6, 7, 11, 12, 13, 14], 
    "3421" => [2, 6, 8, 11, 12],
    "4421" => [2, 6, 8, 11, 12], 
    "3422" => [2, 6, 7, 8, 11, 12, 13, 14],
    "4422" => [2, 6, 7, 8, 11, 12, 13, 14], 
    "4411" => [2, 6, 13, 14],
    "4412" => [2, 6, 13, 14, 15, 16, 17], 
    # 診断結果のパターンが増えるごとに、ここに定義を追加していきます
    }.freeze

        def index
    age = params[:age]
    sex = params[:sex]
    glasses = params[:glasses]
    date = params[:date]

    # 診断コードを生成（例 "1121" など）
    @result = age.to_s + sex.to_s + glasses.to_s + date.to_s

    # 診断コードに対応する book_id の配列を取得
    recommended_ids = DIAGNOSIS_MAP[@result]

    if recommended_ids.present?
        posts = Post.where(book_id: recommended_ids)

        # MySQL なら FIELD() が使える → 本番環境向け
        if ActiveRecord::Base.connection.adapter_name.downcase.include?("mysql")
        order_clause = "FIELD(book_id, #{recommended_ids.join(',')})"
        @diagnosis_results = posts.order(Arel.sql(order_clause))
        else
        # SQLite/PostgreSQL → Ruby で順番を並び替える（開発環境向け）
        @diagnosis_results = posts.sort_by { |p| recommended_ids.index(p.book_id) }
        end
    else
        # 対応する診断結果がない場合
        @diagnosis_results = []
        flash[:alert] = "診断結果に対応する教材が見つかりませんでした。"
    end
    end




    private
    def post_params
        params.require(:post).permit(:title, :image_id,:number, :content, :book_id, :reason, :amazon_url)
    end
end
